<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI DocChat</title>
    <style>
        :root {
            --bg-color: #343541;
            --sidebar-bg: #202123;
            --chat-bg: #444654;
            --text-color: #ececf1;
            --input-bg: #40414f;
            --border-color: #565869;
            --btn-color: #10a37f;
            --btn-hover: #1a7f64;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .sidebar h2 { margin: 0; font-size: 1.2rem; }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label { font-size: 0.9rem; color: #c5c5d2; }
        
        select, input[type="file"] {
            background: var(--input-bg);
            color: white;
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        button {
            background-color: var(--btn-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background-color: var(--btn-hover); }
        
        #status-msg {
            font-size: 0.85rem;
            color: #ccc;
            margin-top: 10px;
            word-wrap: break-word;
        }

        /* Main Chat Area */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            padding-bottom: 100px; /* Space for input */
        }

        .message {
            padding: 24px;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .user-msg { background-color: var(--bg-color); }
        .bot-msg { background-color: var(--chat-bg); }
        
        .msg-content {
            max-width: 800px;
            width: 100%;
            display: flex;
            gap: 20px;
        }
        
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .user-avatar { background: #5436DA; }
        .bot-avatar { background: #10a37f; }
        
        .text {
            line-height: 1.6;
            margin-top: 2px;
        }

        /* Input Area */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(53,53,65,0), var(--bg-color) 40%);
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .input-wrapper {
            max-width: 800px;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }

        input[type="text"] {
            width: 100%;
            background-color: var(--input-bg);
            color: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 16px 45px 16px 16px; /* Right padding for send button */
            font-size: 1rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            outline: none;
        }
        
        .send-btn {
            position: absolute;
            right: 10px;
            background: transparent;
            color: #ccc;
            padding: 5px;
        }
        .send-btn:hover { background: transparent; color: white; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>üìÑ DocChat Local</h2>
    <div class="control-group">
        <label for="model-select">Select LLM:</label>
        <select id="model-select">
           <option value="llama3:latest">Llama 3 (Installed)</option>
        </select>
    </div>

    <div class="control-group">
        <label>Upload Document:</label>
        <input type="file" id="file-upload" accept=".pdf,.docx,.xlsx,.xls">
    </div>

    <button type="button" onclick="uploadFile()">Process Document</button>
    <div id="status-msg"></div>
</div>

<div class="main-content">
    <div id="chat-container">
        <!-- Welcome Message -->
        <div class="message bot-msg">
            <div class="msg-content">
                <div class="avatar bot-avatar">AI</div>
                <div class="text">Hello! Upload a PDF, Word, or Excel file on the left, select your Ollama model, and I'll answer questions about it.</div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="user-input" placeholder="Send a message..." onkeypress="handleKeyPress(event)">
            <button type="button" class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<script>
    async function uploadFile() {
        const fileInput = document.getElementById('file-upload');
        const modelSelect = document.getElementById('model-select');
        const statusDiv = document.getElementById('status-msg');
        
        if (!fileInput.files[0]) {
            statusDiv.innerText = "‚ö†Ô∏è Please select a file first.";
            statusDiv.style.color = "#ff6b6b";
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('model', modelSelect.value);

        statusDiv.innerText = "‚è≥ Processing... (May take a moment)";
        statusDiv.style.color = "#ccc";
        
        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const result = await response.json();
            
            if (response.ok) {
                statusDiv.innerText = "‚úÖ " + result.message;
                statusDiv.style.color = "#10a37f";
            } else {
                statusDiv.innerText = "‚ùå " + result.error;
                statusDiv.style.color = "#ff6b6b";
            }
        } catch (error) {
            statusDiv.innerText = "‚ùå Connection failed.";
            statusDiv.style.color = "#ff6b6b";
        }
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        input.value = '';

        // Add loading indicator
        const loadingId = addLoadingMessage();

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: message })
            });
            const data = await response.json();
            
            // Remove loading and add response
            removeMessage(loadingId);
            addMessage(data.response, 'bot');
        } catch (error) {
            removeMessage(loadingId);
            addMessage("Sorry, I couldn't connect to the server.", 'bot');
        }
    }

    function addMessage(text, sender) {
        const container = document.getElementById('chat-container');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-msg`;
        
        const avatarClass = sender === 'user' ? 'user-avatar' : 'bot-avatar';
        const avatarText = sender === 'user' ? 'U' : 'AI';
        
        // Convert newlines to <br> for simple markdown-like effect
        const formattedText = text.replace(/\n/g, '<br>');

        msgDiv.innerHTML = `
            <div class="msg-content">
                <div class="avatar ${avatarClass}">${avatarText}</div>
                <div class="text">${formattedText}</div>
            </div>
        `;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

    function addLoadingMessage() {
        const container = document.getElementById('chat-container');
        const id = 'loading-' + Date.now();
        const msgDiv = document.createElement('div');
        msgDiv.id = id;
        msgDiv.className = `message bot-msg`;
        msgDiv.innerHTML = `
            <div class="msg-content">
                <div class="avatar bot-avatar">AI</div>
                <div class="text">Thinking...</div>
            </div>
        `;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') sendMessage();
    }
</script>

</body>
</html>